<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">   
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link href="/style.css" rel="stylesheet">
    <link rel="icon" href="/imgs/icon.png">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <title>Order Page</title>
</head>
<body>

    <header class="header">
        <img alt="minim" src="/imgs/d-minim.jpg" id="bg-img-head">
        <div class="w-100 navbar px-3">
            <div class="w-100 p-2 row mx-0">
                <div class="col col-10 c-y txt-head">
                    Order
                </div>
                <div class="col col-2 text-right" style="font-family: cursive;">
                    <h5 class="text-success">ב"ה</h5>
                </div>
            </div>
            <nav class="navbar navbar-expand-lg navbar-light bg-success w-100" style="justify-content:space-between;border-radius:0 0 20px 20px;border-top:4px solid #eff157;">
                <a href="/"><img src="/imgs/icon.png" class="icon navbar-brand"></a>
            </nav>
        </div>
        <div class="w-100 p-3 text-center" style="position:relative; top:70px;">
             <h1 class="c-y txt-head" id="h1-name"></h1>
             <a href="#sale"><h5 class="c-y txt-head"><small><i class="fa fa-arrow-right"></i> Hot sales <i class="fa fa-arrow-left"></i></small></h5></a>
        </div>
        <a href="#main"><i class="fa fa-caret-down fa-4x text-success" id="carret-down"></i></a>
    </header>

    <main id="main" class="py-3">

        <div style="width: 100vw; min-height:50vh;">
            <div id="carousel-control" class="carousel slide" style="min-height:100%;" data-interval="false">
                <div class="carousel-inner py-3" style="min-height:100%;">
                    <div class="carousel-item active">

                        <h1 class="text-center text-warning"><i class="fa fa-plus"></i> Actions</h1>
                        <div class="container row mx-auto mb-5 py-5">
                            <div class="card border-success mx-auto m-2" style="max-width: 18rem;">
                                <div class="card-header bg-success text-light" data-target="#carousel-control" data-slide-to="1">
                                    <i class="fa fa-plus"></i>
                                </div>
                                <div class="card-body text-success">
                                <h5 class="card-title">Create new order</h5>
                                <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                                </div>
                            </div>
                            <div class="card border-warning mx-auto m-2" style="max-width: 18rem;">
                                <div class="card-header bg-warning text-light" data-target="#carousel-control" data-slide-to="2">
                                    <i class="fa fa-cloud-upload"></i>
                                </div>
                                <div class="card-body text-warning">
                                <h5 class="card-title">Update old order</h5>
                                <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                                </div>
                            </div>
                            <div class="card border-dark mx-auto m-2" style="max-width: 18rem;">
                                <div class="card-header bg-dark text-light" data-target="#carousel-control" data-slide-to="3">
                                    <i class="fa fa-trash"></i>
                                </div>
                                <div class="card-body text-dark">
                                <h5 class="card-title">Delete old order</h5>
                                <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                                </div>
                            </div>
                            <div class="card border-info mx-auto m-2" style="max-width: 18rem;">
                                <div class="card-header bg-light text-info" data-target="#carousel-control" data-slide-to="4">
                                    <i class="fa fa-comments"></i>
                                </div>
                                <div class="card-body text-info">
                                <h5 class="card-title">Let's be in touch</h5>
                                <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                                </div>
                            </div>
                        </div>

                        <h1 class="text-center text-primary"><i class="fa fa-shopping-bag"></i> Your orders</h1>
                        <div class="container mx-auto mb-5 py-5">
                            <div id="user-orders-fill">

                            </div>
                            <h5 style="padding-right:1.25rem;" class="py-3 text-right">
                                <span class="badge badge-primary badge-pill" id="user-order-sum"></span>
                            </h5>
                        </div>

                        <h1 class="text-center text-dark"><i class="fa fa-cogs"></i> Profile</h1>
                        <form target="_" class="container mx-auto mb-5 py-5" method="POST" id="profile-form">
                            <ul id="user-profile-fill" class="list-group">
                                
                            </ul>
                        </form>

                        <h1 class="text-center text-success"><i class="fa fa-credit-card"></i> Payment</h1>
                        <div class="container mx-auto mb-5 py-5">
                            <h4>Payment can be sent to Yanky Kahn 18253 Topham St Tarzana CA 91335 818-605-2066</h4>
                            <p><i class="p-3 text-primary fa fa-paypal"></i> Paypal chabad18@hotmail.com</p>
                            <p><i class="p-3 text-success fa fa-dollar"></i>Cash App  8186052066</p>
                        </div>
                       
                    </div>
                    <!--new order-->
                    <div class="carousel-item">
                        <form id="form-new" class="main-form form-size mx-auto bg-white" method="POST" action="">
                            <div class="p-4">
                                <div class="w-100 h-100" style="position: relative;">
                                    <div class="mb-3 fill-d-minim">
                
                                    </div>
                                    <div class="p-4">
                                        <h4 class="c-y">Is your budget for a Yanovar Esrog is under $100 ?! fill out here.</h4>
                                        <small class="text-success">this is for Yanover</small>
                                        <div class="row">
                                            <div class="col">Esrog (min: $50, max:$100)</div>
                                            <div class="col"><input type="number" name="Budget Esrog" min="0" max="10" class="form-control"/></div>
                                            <div class="col"><input placeholder="$" type="number" name="Budget Esrog price" min="50" max="100" class="form-control"/></div>
                                        </div>
                                    </div>
                                    <button type="submit" id="submit-btn" class="btn btn-outline-success">Submit</button>
                                </div>
                            </div>
                        </form>
                        <h4 data-target="#carousel-control" class="py-3 text-info text-center" data-slide-to="0">Back</h4>                       
                    </div>
                    <!--update order-->
                    <div class="carousel-item">
                        <h4>Not Yet</h4>
                        <h4 data-target="#carousel-control" class="py-3 text-info text-center" data-slide-to="0">Back</h4>
                    </div>
                    <!--delete order-->
                    <div class="carousel-item text-center">
                        <div class="container" id="user-orders-delete">

                        </div>
                        <h4 data-target="#carousel-control" class="py-3 text-info text-center" data-slide-to="0">Back</h4>
                    </div>
                    <!--Comment form-->
                    <div class="carousel-item text-center">
                        <div class="container">
                            <form method="POST" id="comment-form" class=" text-left form-size main-form bg-white mx-auto">
                                <h5 class="text-info p-4">Send Comment.</h5>
                                <div class="form-group p-4">
                                    <label for="subject" class="text-info">Subject</label>
                                    <input name="subject" id="subject" type="text" class="form-control" placeholder="Enter Subject">
                                </div>
                                <div class="form-group p-4">
                                    <label for="comment" class="text-info">Comment</label>
                                    <textarea name="text" style="max-height:200px;" id="comment" type="text" class="form-control" placeholder="Enter Subject"></textarea>
                                </div>
                                <div class="form-group p-4">
                                    <button class="btn btn-info">Submit</button>
                                </div>
                            </form>
                        </div>
                        <h4 data-target="#carousel-control" class="py-3 text-info text-center" data-slide-to="0">Back</h4>
                    </div>
                </div>
            </div>
        </div>
        
       
    </main>

    <footer class="bg-success p-3 pt-5 w-100 text-white">
        <div class="row w-100 pl-3">
             <div class="col-6 col-or-row">
                 <h5>About</h5>
                 <p><em class="btn-success btn" id="yanky">Yanky Kahn</em> <a class="c-y" href="tel:+18186052066"><i class="fa fa-phone"></i></a> <a class="c-y" href="mailto:chabad18@hotmail.com"><i class="fa fa-paper-plane"></i></a> 
                 <a class="c-y" target="_blank" href="https://maps.google.com/?q=18253 Topham St Tarazana CA 91335"><i class="fa fa-map-marker"></i></a> 
             </div>
             <div class="col-6 col-or-row" id="sale">
                 <h5>Sale</h5>
                 <ul>
                     <li class="c-y"><small class="text-white">Buy an israeli esrog & get the all set</small></li>
                     <li class="c-y"><small class="text-white">Buy an yanever esrog in more then $75 & get the all set + 'meodar' Hadasim</small></li>
                 </ul>
             </div>
        </div>
        <p><small>Created with &#10084; by Yudi Kahn &copy; <script>document.write(new Date().getFullYear())</script></small></p>
     </footer>

    <script type="text/javascript">
        window.onload = ()=> {

            //user id
            const urlArray = window.location.href.toString().split(/[# , /]/);
            const urlId = urlArray[4];

            //comment form action
            document.getElementById('comment-form').action=`/user/${urlId}/comment`;
            //profile form action
            document.getElementById('profile-form').action=`/profile/update/${urlId}`;
            document.getElementById('profile-form').addEventListener('submit',function(e){
                location.reload();
               /* e.preventDefault();
                for(let i=2;i<10;i++){
                    console.log(e.target[i].value)
                }*/
            })

            //some responsive effects
            function changeImgAndColOrRow(){
                let w = window.innerWidth;
                let img = document.getElementById('bg-img-head');

                if(w<500){  img.src="/imgs/d-minim-s.png";}
                else{ img.src="/imgs/d-minim.jpg"; }
                document.querySelectorAll('.col-or-row').forEach(d=>{ if(w<500){ d.classList.remove('col-6');}  else{ d.classList.add('col-6');}})
            }
            changeImgAndColOrRow();
            window.addEventListener('resize', changeImgAndColOrRow);

            //fill user profile
            function fillUserProfile(user){
               let profileDiv = document.getElementById('user-profile-fill');
               let txt=`<li class="list-group-item d-flex justify-content-between align-items-center">
                <div class="custom-control custom-switch">
                <input type="checkbox" class="custom-control-input" id="modify-profile">
                <label class="custom-control-label" for="modify-profile">Modify profile.</label>
                </div><button disabled type="submit" class="p-1 badge badge-primary badge-pill" id="submit-profile">SUBMIT</button>         
                </li>`;
               Object.keys(user).sort().map(d=>{
                   if(d == 'address'){
                        Object.keys(user[d]).sort().map(a=>{
                            txt+=`<li class="list-group-item d-flex justify-content-between align-items-center">
                             ${a}<input name="${a}" style="max-width:200px" type="${a=='zip'?'number':'text'}" value="${user[d][a]}" disabled class="form-control profile-input"></li>`;
                        })
                   }else
                   txt+=`<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${d}<input style="max-width:200px" name="${d}" type="text" value="${user[d]}" disabled class="form-control profile-input"></li>`;
               })
               profileDiv.innerHTML=txt;
               //manage profile update
               document.getElementById('modify-profile').addEventListener('click', function(e){
                   let btn = document.getElementById('submit-profile');
                   
                   let isCheck = e.target.checked;
                   btn.disabled = !isCheck;
                   document.querySelectorAll('.profile-input').forEach(input=>{
                       input.disabled = !isCheck;
                   })
               })
            }

            //get user name
            let getUser = new XMLHttpRequest();
            getUser.onreadystatechange = function(){
                if (this.readyState == 4 && this.status == 200){
                        let user = JSON.parse(this.responseText);
                        //fill user name
                        let welcomeTxt = `Welcome`;
                        document.getElementById('h1-name').innerHTML=`${welcomeTxt} ${user.firstName} ${user.lastName}`;                
                        //fill user profile
                        fillUserProfile(user);
                }    
            }
            getUser.open("GET", `/user/${urlId}`, true);
            getUser.send();

            //gets all ordrs for user
            function getAllOrders(){
                let orders = new XMLHttpRequest();
                orders.onreadystatechange = function(){
                    if(this.readyState == 4 && this.status == 200){
                        const orders = JSON.parse(this.responseText);
                        let htmlTxt = "";
                        let htmlTxtForDel="";
                        if(orders.length>0){
                            for(let order of orders){
                                let date = `${new Date(order.createdAt).toDateString()} ${new Date(order.createdAt).getHours()}:${new Date(order.createdAt).getMinutes()}`;
                                htmlTxtForDel+=`<button class="btn-delete-order btn btn-block btn-danger w-75 mx-auto my-4" 
                                value="${order._id}">Delete order created at ${date}</button>`;
                                htmlTxt+='<ul class="list-group">';
                                for(let item of order.items){
                                    htmlTxt+=`<li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${item.item}<span class="badge badge-primary badge-pill">${item.q}</span></li>`
                                }
                                htmlTxt+=`</ul><h5 style="padding:1.25rem;" class="d-flex justify-content-between align-items-center py-3">
                                <small>created at :${date}</small>
                                <span class="badge badge-primary badge-pill">TOTAL :$${order.sum}</span></h5>`;
                            }
                        }else{
                            let txt = '<h5 class="text-warning text-center">There are no orders.</h5>';
                            htmlTxtForDel=txt;htmlTxt=txt;
                        }
                        document.getElementById('user-orders-fill').innerHTML=htmlTxt;
                        document.getElementById('user-orders-delete').innerHTML=htmlTxtForDel;
                        enableBtns();
                    }
                }
                orders.open("GET", `/orders/${urlId}/all`, true);
                orders.send();
            }getAllOrders();

            //delete order
            function enableBtns(){
                document.querySelectorAll('.btn-delete-order').forEach(btn=>{
                    btn.addEventListener('click', ()=>{
                        let del = new XMLHttpRequest();
                        del.onreadystatechange = function(){
                            if(this.readyState==4 && this.status==200){
                                location.reload();
                            }
                        }
                        del.open("POST", `/order/${btn.value}/delete`, true);
                        del.send();
                    })
                })
            }

            //form update order action
            //document.getElementById('form-update').action=`/order/${urlId}/update`;

            //form create order action
            document.getElementById('form-new').action=`/order/${urlId}/new`;
            
            //form comment action
            //document.getElementById('comment-form').action=`/comment/${urlId}/send`

            //check inputs
            function checkInputs(){
                document.querySelectorAll('input').forEach((inp,ind)=>{
                    if(inp.min){
                        let min = inp.min;
                        let max = inp.max||2000;
                        inp.addEventListener('input', function(){
                            if(Number(this.value) > max || Number(this.value) < min){
                                this.style.color="red";
                            }else{
                                this.style.color="black"
                            }
                        })
                    }
                });
            }

            //fill d minim form
            let xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    let arr = JSON.parse(this.responseText);
                    let tmpMinimArr = ['Israeli Esrog set','Yanover Esrog set','Lulav','Hadasim','Aruvos','Hoshnos','Schach','Lulav Bag'];
                    let comment = ['Each set comes complete with Lulav, Esrog, Hadasim, Aruvos, Koshelach & Plastic bag',
                         'Each set comes complete with Lulav, Esrog, Hadasim "רובו חיים נאה & כולו חיים נאה",  Aruvos & Plastic bag',
                         'if you want additional lulavim', 'if you want additional hadasim', 'if you want additional aruvos']
                    let itemsToGoOver = [1, 2 ,3 ,4, 5, 6, 9, 10];
                    //israeli set, yanever, lulav, arava, hadas, hushana, schach, lulav bag.

                    document.querySelectorAll('.fill-d-minim').forEach(minim=>{
                        tmpMinimArr.map((d,index)=>{
                            minim.innerHTML+=`<div class="p-3" id="min-${d}">
                            <h2 class="text-success">${d}</h2><small class="text-dark">${comment[index]?comment[index]:''}</small>
                            ${
                                arr.filter(d=>d.n==itemsToGoOver[index]).map(m=>`<div class="row">
                                <div class="col ${m.t.toString().includes('NO')?'text-warning':''}">${m.t}
                                    ${m.n==1?`<b style="color:black;text-decoration:underline;">${m.p>25?'Mehudar':m.p<25?'Standard':'Chinuch'}</b>`:''}</div>
                                <div class="col"><input type="number" name="${m.t}" min="0" class="form-control"></div>
                                <div class="col">$ ${m.p}</div>
                                </div>`)
                            }
                            </div>`;
                        }); 
                    });
                    checkInputs();
                }
            };
            xhttp.open("GET", "/items", true);
            xhttp.send();

            //secret
            document.getElementById('yanky').addEventListener('click', e=>{
                if(e.detail==3){
                    window.location = "/auth.html";
                }
            })
        }
    </script>
</body>
</html>
<!---->